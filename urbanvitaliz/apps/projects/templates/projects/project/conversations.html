{% extends "projects/project/detail.html" %}

{% load guardian_tags %}

{% load static %}
{% load humanize %}
{% load gravatar %}
{% load training %}

{% block title %}
{{ block.super }} > Conversations
{% endblock %}

{% block project_detail %}

{% challenge_for request.user "project-conversation-reader" as challenge %}

{% if challenge and not challenge.acquired %}
{% challenge_acquire challenge %}
{% endif %}

{% challenge_for request.user "project-conversation-writer" as challenge %}

<div class="col-12 mx-auto">
    {% get_obj_perms user for project as "permissions" %}
    {% include 'projects/project/navigation.html' with conversation=True %}
    <div class="row">
        <div class="col-12 col-lg-8">
            {% regroup project.notes.public by created_on.date as notes_by_day %}
            <div class="message-window flex-grow-1" style="overflow-y: auto; overflow-x: hidden; max-height: 40vh; display:flex; flex-direction:column-reverse;">
                <ul class="list-group">
                    {% for date, notes in notes_by_day|slice:":20" reversed %}
                    <li class="list-group-item border-0 m-0 p-0">
                        <div class="small my-2 text-center w-100 text-secondary">{{ date|naturalday|capfirst }}</div>
                        {% for note in notes reversed  %}
                            {% if request.user == note.created_by %}
                                <div class="rounded-3 p-3 text-secondary bg-blue-light my-2" style="margin-left: 2vw;">
                            {% else %}
                                <div class="bg-grey-light rounded-3 p-3 text-secondary my-2" style="margin-right: 2vw;">
                            {% endif %}
                                {{ note.content_rendered|safe }}
                                {% if note.document.count %}
                                    {% for document in note.document.all %}
                                            {% include 'projects/project/fragments/files_links/file_list_item_embedded.html' with document=document %}
                                    {% endfor %}
                                {% endif %}
                            {% if note.created_by %}
                            <div>
                                <span class="align-items-center link-dark text-decoration-none">
                                    <img
                                        src="{% gravatar_url note.created_by.email 16 %}"
                                        alt="{{ note.created_by.get_full_name }}"
                                        class="me-1 rounded-circle"
                                        style="width: 16px; height: 16px;"
                                    />
                                </span>
                                <span class="align-middle small text-dark">
                                    {{ note.created_by.get_full_name|capfirst|default:note.created_by }}
                                </span>
                                {% if note.created_by == request.user %}
                                <span class="align-middle small text-dark">
                                    - <a href="{% url 'projects-update-note' note.pk %}">éditer</a>
                                </span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </li>
                    {% endfor %}
                </ul>
            </div>

            {% if "use_public_notes" in permissions %}
            <hr/>

            <!-- Post message -->
            <div class="message-form mt-4 p-3 bg-light border-form">
                <form class="form"
                      method="POST"
                      action="{% url 'projects-conversation-create-message' project.pk %}"
                      enctype="multipart/form-data"
                      id="conversation-form">
                    {% csrf_token %}
                    
                    {% include 'tools/editor.html' with input_name=public_note_form.content.name input_value=public_note_form.content.value|default:'' input_required=True %}
                    <label class="visually-hidden" for="input-project-content">{{ public_note_form.content.label }}</label>

                    {% for error in public_note_form.content.errors %}
                    <div class="text-danger text-end">{{ error }}</div>
                    {% endfor %}

                    {% include 'projects/project/fragments/files_links/file_upload_input_standalone.html' %}

                    <div class="d-flex justify-content-end mt-4">
                        <button form="conversation-form" class="button filled" type="submit">Envoyer</button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
        <div class="col mx-auto col-lg-4 col-md-12">
            <h6 style="font-size: 14px;" class="text-uppercase fw-bold d-block mb-3">Participants</h6>
            <div>
                <p class="text-info-custom">Membres de la collectivité</p>
                <ul class="flex-column list-unstyled mb-0">
                        {% for member in project.members.all %}
                        {% if forloop.counter0 == 0 %}
                            <li>
                                {% include 'projects/project/fragments/project_owner.html' with project=project %}
                            </li>
                            {% else %}
                            <li>
                                {% include 'projects/project/fragments/user.html' with member=member project=project %}
                            </li>
                            {% endif %}
                            {% endfor %}
                </ul>
            </div>
            <div class="d-block mt-4">
                <p class="text-info-custom">Équipe de suvi</p>
                <ul class="d-flex flex-column list-unstyled mb-0">
                    {% for advisor in project.switchtenders_on_site.all %}
                    <li>
                        {% include 'projects/project/fragments/advisor_item.html' with advisor=advisor %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
